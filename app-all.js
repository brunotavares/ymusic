/*
Copyright(c) 2011 Company Name
*/
Ext.define("Ext.data.proxy.YMusic",{extend:"Ext.data.proxy.JsonP",requires:["Ext.XTemplate"],autoAppendParams:false,url:"http://query.yahooapis.com/v1/public/yql",queries:{newReleases:Ext.create("Ext.XTemplate",["select * from music.release.popular"]),popular:Ext.create("Ext.XTemplate",["select * from music.track.popular"]),artists:Ext.create("Ext.XTemplate",['select * from music.artist.search where keyword="{artist}"']),},buildRequest:function(a){var e=this,d=e.callParent(arguments),b=e.queries[e.query],c=a.filters||[],f={};Ext.iterate(c,function(g){f[g.property]=g.value});delete d.params.filters;Ext.applyIf(d.params,{format:"json",q:b.applyTemplate(f)});d.url=Ext.urlAppend(d.url,Ext.urlEncode(d.params));return d}});Ext.define("YM.view.Viewport",{extend:"Ext.tab.Panel",config:{fullscreen:true,items:[{xtype:"releaselist"},{xtype:"popularlist"},{xtype:"artistslist"}]}});Ext.define("YM.view.ReleaseList",{extend:"Ext.dataview.List",alias:"widget.releaselist",config:{title:"New Releases",store:"Releases",itemTpl:new Ext.XTemplate('<div class="release">{[this.getAutoIndex()]}. {artist} - {title}</div>',{getAutoIndex:function(){this.autoIndex=this.autoIndex||1;return this.autoIndex++}})}});Ext.define("YM.view.PopularList",{extend:"Ext.dataview.List",alias:"widget.popularlist",config:{title:"Popular",store:"Populars",itemTpl:new Ext.XTemplate('<div class="release">{[this.getAutoIndex()]}. {artist} - {title}</div>',{getAutoIndex:function(){this.autoIndex=this.autoIndex||1;return this.autoIndex++}})}});Ext.define("YM.view.ArtistsList",{extend:"Ext.Container",alias:"widget.artistslist",config:{layout:"fit",title:"Artists",items:[{xtype:"toolbar",docked:"top",ui:"light",layout:"fit",items:[{xtype:"textfield",placeHolder:"Search..."}]},{xtype:"list",store:"Artists",itemTpl:"{name}",}]}});Ext.define("YM.model.Track",{extend:"Ext.data.Model",fields:["id","title","url",{name:"artist",mapping:"Artist.name"}]});Ext.define("YM.model.Artist",{extend:"Ext.data.Model",fields:["id","name","url"]});Ext.define("YM.store.Releases",{extend:"Ext.data.Store",model:"YM.model.Track",autoLoad:true,proxy:{type:"ymusic",query:"newReleases",reader:{type:"json",successProperty:"success",root:function(a){if(a.error||a.query.count===0){return[]}else{return a.query.results.Release}}}}});Ext.define("YM.store.Populars",{extend:"Ext.data.Store",model:"YM.model.Track",autoLoad:true,proxy:{type:"ymusic",query:"popular",reader:{type:"json",successProperty:"success",root:function(a){if(a.error||a.query.count===0){return[]}else{return a.query.results.Track}}}}});Ext.define("YM.store.Artists",{extend:"Ext.data.Store",model:"YM.model.Artist",remoteFilter:true,proxy:{type:"ymusic",query:"artists",reader:{type:"json",successProperty:"success",root:function(a){if(a.error||a.query.count===0){return[]}else{return a.query.results.Artist}}}}});Ext.define("YM.controller.Main",{extend:"Ext.app.Controller",stores:["Releases","Populars","Artists"],views:["Viewport","ReleaseList","PopularList","ArtistsList"],init:function(){var a=this;a.control({"artistslist > toolbar > textfield":{change:a.onArtistSearchChange,clearicontap:a.onArtistSearchChange},releaselist:{select:a.onItemWithUrlTap},popularlist:{select:a.onItemWithUrlTap},"artists list":{select:a.onItemWithUrlTap}});a.callParent(arguments)},onArtistSearchChange:function(b){var a=this.getArtistsStore(),c=Ext.String.trim(b.getValue());if(Ext.isEmpty(c)){a.removeAll()}else{a.clearFilter();a.filter("artist",c)}},onItemWithUrlTap:function(b,a){window.open(a.get("url"))}});Ext.Loader.setConfig({enabled:true});Ext.Loader.setPath("Ext.data.proxy.YMusic","lib/YMusicProxy.js");Ext.ClassManager.setAlias("Ext.data.proxy.YMusic","proxy.ymusic");Ext.require(["Ext.data.proxy.YMusic","Ext.XTemplate","Ext.field.Text"]);Ext.application({name:"YM",tabletStartupScreen:"resources/images/tablet_startup.png",phoneStartupScreen:"resources/images/phone_startup.png",icon:"resources/images/ymusic.png",controllers:["Main"],models:["Track","Artist"],launch:function(){Ext.create("YM.view.Viewport")}});
